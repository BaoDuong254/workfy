name: Deploy Production

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Create .env file for server
              run: echo "${{ secrets.SERVER_ENV }}" > server/.env

            - name: Create .env file for client
              run: echo "${{ secrets.CLIENT_ENV }}" > client/.env

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_PASSWORD }}

            - name: Build and push server image
              uses: docker/build-push-action@v5
              with:
                  context: ./server
                  file: ./server/Dockerfile
                  push: true
                  tags: ${{ secrets.DOCKERHUB_USERNAME }}/workfy-server:latest
                  cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/workfy-server:buildcache
                  cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/workfy-server:buildcache,mode=max

            - name: Build and push client image
              uses: docker/build-push-action@v5
              with:
                  context: ./client
                  file: ./client/Dockerfile
                  push: true
                  tags: ${{ secrets.DOCKERHUB_USERNAME }}/workfy-client:latest
                  cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/workfy-client:buildcache
                  cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/workfy-client:buildcache,mode=max

            - name: Send telegram message after build success
              if: success()
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_TO }}
                  token: ${{ secrets.TELEGRAM_TOKEN }}
                  message: |
                      âœ… Build and push Docker images completed successfully.
                      ğŸ‘¤ ${{ github.actor }} created commit:
                      ğŸ§‘â€ğŸ’» Commit message: ${{ github.event.commits[0].message }}
                      ğŸ“¦ Repository: ${{ github.repository }}
                      ğŸ³ Images: 
                      - ${{ secrets.DOCKERHUB_USERNAME }}/workfy-server:latest
                      - ${{ secrets.DOCKERHUB_USERNAME }}/workfy-client:latest
                      ğŸ‘€ See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}

            - name: Send telegram message after build failure
              if: failure()
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_TO }}
                  token: ${{ secrets.TELEGRAM_TOKEN }}
                  message: |
                      âŒ Build and push Docker images failed.
                      ğŸ‘¤ ${{ github.actor }} created commit:
                      ğŸ§‘â€ğŸ’» Commit message: ${{ github.event.commits[0].message }}
                      ğŸ“¦ Repository: ${{ github.repository }}
                      ğŸ‘€ See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}

    deploy:
        runs-on: ubuntu-latest
        needs: build-and-push
        steps:
            - name: Checkout code for docker-compose
              uses: actions/checkout@v4

            - name: Create .env file for server
              run: echo "${{ secrets.SERVER_ENV }}" > server/.env

            - name: Create .env file for client
              run: echo "${{ secrets.CLIENT_ENV }}" > client/.env

            - name: Copy files to LXC
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.HOST_VPS }}
                  username: ${{ secrets.USERNAME_VPS }}
                  key: ${{ secrets.KEY_VPS }}
                  port: ${{ secrets.PORT_VPS }}
                  source: "server/.env,client/.env,docker-compose.yml"
                  target: "~/workfy"

            - name: Deploy to LXC via SSH
              uses: appleboy/ssh-action@v1.2.2
              with:
                  host: ${{ secrets.HOST_VPS }}
                  username: ${{ secrets.USERNAME_VPS }}
                  key: ${{ secrets.KEY_VPS }}
                  port: ${{ secrets.PORT_VPS }}
                  script: |
                      cd ~/workfy

                      # Login to Docker Hub
                      echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

                      # Set environment variable for docker-compose
                      export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}

                      # Stop and remove old containers first
                      docker compose down

                      # Pull latest images
                      docker compose pull

                      # Start containers with new images
                      docker compose up -d

                      # Clean up unused images
                      docker image prune -af

                      # Show running containers
                      docker compose ps

            - name: Send telegram message after deploy success
              if: success()
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_TO }}
                  token: ${{ secrets.TELEGRAM_TOKEN }}
                  message: |
                      âœ… Deployment to LXC completed successfully.
                      ğŸ‘¤ ${{ github.actor }} created commit:
                      ğŸ§‘â€ğŸ’» Commit message: ${{ github.event.commits[0].message }}
                      ğŸ“¦ Repository: ${{ github.repository }}
                      ğŸš€ Application is now running on LXC
                      ğŸ‘€ See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}

            - name: Send telegram message after deploy failure
              if: failure()
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_TO }}
                  token: ${{ secrets.TELEGRAM_TOKEN }}
                  message: |
                      âŒ Deployment to LXC failed.
                      ğŸ‘¤ ${{ github.actor }} created commit:
                      ğŸ§‘â€ğŸ’» Commit message: ${{ github.event.commits[0].message }}
                      ğŸ“¦ Repository: ${{ github.repository }}
                      ğŸ‘€ See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}
